<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¼«ç•«ç®¡ç†ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    header h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 900px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .upload-zone {
      border: 2px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9ff;
    }

    .upload-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-zone.dragover {
      border-color: #764ba2;
      background: #e8ecff;
      transform: scale(1.02);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    input[type="text"],
    input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="file"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .preview-section {
      margin-top: 20px;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .preview-item {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .preview-item img {
      width: 100%;
      height: 130px;
      object-fit: cover;
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #eee;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      border-left: 4px solid #667eea;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    .comic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .comic-card {
      background: #f8f9ff;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .comic-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      transform: translateY(-3px);
    }

    .comic-thumbnail {
      width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3em;
    }

    .comic-info {
      padding: 15px;
    }

    .comic-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .comic-meta {
      font-size: 0.85em;
      color: #999;
      margin-bottom: 10px;
    }

    .comic-actions {
      display: flex;
      gap: 8px;
    }

    .comic-actions button {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.9em;
    }

    .btn-view {
      background: #667eea;
      color: white;
    }

    .btn-view:hover {
      background: #5568d3;
    }

    .btn-delete {
      background: #ff6b6b;
      color: white;
    }

    .btn-delete:hover {
      background: #ff5252;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    .loading {
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 6px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }

    .toast.info {
      background: #2196f3;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“š æ¼«ç•«ç®¡ç†ç³»çµ±</h1>
      <p style="font-size: 1.1em; opacity: 0.9;">è¼•é¬†ç®¡ç†æ‚¨çš„æ¼«ç•«æ”¶è—</p>
    </header>

    <div class="content">
      <!-- ä¸Šå‚³å€ -->
      <div class="card">
        <h2>ğŸ“¤ ä¸Šå‚³æ¼«ç•«</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="comicName">æ¼«ç•«åç¨± *</label>
            <input type="text" id="comicName" name="name" placeholder="è¼¸å…¥æ¼«ç•«åç¨±" required>
          </div>

          <div class="form-group">
            <label for="imageInput">é¸æ“‡åœ–ç‰‡ *</label>
            <div class="upload-zone" id="uploadZone">
              <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
              <p>é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡åˆ°é€™è£¡</p>
              <p style="font-size: 0.9em; color: #999; margin-top: 5px;">æ”¯æ´å¤šå¼µåœ–ç‰‡ä¸Šå‚³</p>
              <input type="file" id="imageInput" name="images" multiple accept="image/*" style="display: none;">
            </div>
          </div>

          <div id="preview" class="preview-section" style="display: none;">
            <p style="color: #999; margin-bottom: 10px;">é è¦½åœ–ç‰‡ï¼š</p>
            <div id="previewGrid" class="preview-grid"></div>
          </div>

          <div id="progressContainer" style="display: none;">
            <p style="color: #999; margin-bottom: 5px; font-size: 0.9em;">ä¸Šå‚³é€²åº¦ï¼š<span id="progressPercent">0</span>%</p>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn-primary" id="uploadBtn">ä¸Šå‚³</button>
            <button type="button" class="btn-secondary" id="resetBtn">æ¸…é™¤</button>
          </div>
        </form>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="card">
        <h2>ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number" id="totalComics">0</div>
            <div class="stat-label">ç¸½æ¼«ç•«æ•¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalPages">0</div>
            <div class="stat-label">ç¸½é æ•¸</div>
          </div>
        </div>
        <div style="background: #fffbea; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-top: 15px;">
          <p style="color: #856404; font-size: 0.9em;">ğŸ’¡ æç¤ºï¼šé»æ“Šæ¼«ç•«å¡ç‰‡å¿«é€Ÿé è¦½ï¼Œæˆ–ä½¿ç”¨åˆªé™¤æŒ‰éˆ•ç§»é™¤ä¸éœ€è¦çš„æ¼«ç•«ã€‚</p>
        </div>
      </div>
    </div>

    <!-- æ¼«ç•«åˆ—è¡¨ -->
    <div class="card">
      <h2>ğŸ“– æ¼«ç•«åˆ—è¡¨</h2>
      <div id="comicListContainer">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“š</div>
          <p>é‚„æ²’æœ‰æ¼«ç•«ï¼Œä¸Šå‚³ç¬¬ä¸€æœ¬å§ï¼</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const imageInput = document.getElementById('imageInput');
    const uploadZone = document.getElementById('uploadZone');
    const previewSection = document.getElementById('preview');
    const previewGrid = document.getElementById('previewGrid');
    const comicListContainer = document.getElementById('comicListContainer');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const totalComicsSpan = document.getElementById('totalComics');
    const totalPagesSpan = document.getElementById('totalPages');
    const uploadBtn = document.getElementById('uploadBtn');
    const resetBtn = document.getElementById('resetBtn');

    // æ‹–æ‹½ä¸Šå‚³
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      imageInput.files = e.dataTransfer.files;
      updatePreview();
    });

    uploadZone.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', updatePreview);

    function updatePreview() {
      if (imageInput.files.length === 0) {
        previewSection.style.display = 'none';
        return;
      }

      previewSection.style.display = 'block';
      previewGrid.innerHTML = '';

      Array.from(imageInput.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'preview-item';
          const img = document.createElement('img');
          img.src = e.target.result;
          div.appendChild(img);
          previewGrid.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    resetBtn.addEventListener('click', () => {
      form.reset();
      previewSection.style.display = 'none';
      previewGrid.innerHTML = '';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const comicName = document.getElementById('comicName').value.trim();
      
      if (!comicName) {
        showToast('è«‹è¼¸å…¥æ¼«ç•«åç¨±', 'error');
        return;
      }

      if (imageInput.files.length === 0) {
        showToast('è«‹é¸æ“‡è‡³å°‘ä¸€å¼µåœ–ç‰‡', 'error');
        return;
      }

      uploadBtn.disabled = true;
      progressContainer.style.display = 'block';
      uploadBtn.textContent = 'ä¸Šå‚³ä¸­...';

      const formData = new FormData(form);
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressFill.style.width = percentComplete + '%';
            progressPercent.textContent = Math.round(percentComplete);
          }
        });

        xhr.addEventListener('load', async () => {
          if (xhr.status === 201) {
            showToast('æ¼«ç•«ä¸Šå‚³æˆåŠŸï¼', 'success');
            form.reset();
            previewSection.style.display = 'none';
            previewGrid.innerHTML = '';
            progressContainer.style.display = 'none';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0';
            await loadComics();
          } else {
            const res = JSON.parse(xhr.responseText);
            showToast(res.message || 'ä¸Šå‚³å¤±æ•—', 'error');
          }
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'ä¸Šå‚³';
        });

        xhr.addEventListener('error', () => {
          showToast('ä¸Šå‚³å‡ºéŒ¯ï¼Œè«‹é‡è©¦', 'error');
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'ä¸Šå‚³';
        });

        xhr.open('POST', '/uploadComic');
        xhr.send(formData);
      } catch (err) {
        console.error(err);
        showToast('ä¸Šå‚³å¤±æ•—', 'error');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šå‚³';
      }
    });

    async function loadComics() {
      try {
        const res = await fetch('/listComics');
        const comics = await res.json();

        totalComicsSpan.textContent = comics.length;

        // è¨ˆç®—ç¸½é æ•¸
        let totalPages = 0;
        for (const comic of comics) {
          const comicData = await fetch(`/getComic/${encodeURIComponent(comic.name)}`);
          const data = await comicData.json();
          totalPages += data.pages.length;
        }
        totalPagesSpan.textContent = totalPages;

        if (comics.length === 0) {
          comicListContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“š</div>
              <p>é‚„æ²’æœ‰æ¼«ç•«ï¼Œä¸Šå‚³ç¬¬ä¸€æœ¬å§ï¼</p>
            </div>
          `;
          return;
        }

        comicListContainer.innerHTML = '';
        const comicGrid = document.createElement('div');
        comicGrid.className = 'comic-grid';

        for (const comic of comics) {
          const comicData = await fetch(`/getComic/${encodeURIComponent(comic.name)}`);
          const data = await comicData.json();
          const pageCount = data.pages.length;

          const card = document.createElement('div');
          card.className = 'comic-card';
          card.innerHTML = `
            <div class="comic-thumbnail">
              ğŸ“– ${pageCount}é 
            </div>
            <div class="comic-info">
              <div class="comic-name">${escapeHtml(comic.name)}</div>
              <div class="comic-meta">${pageCount} é </div>
              <div class="comic-actions">
                <button class="btn-view" onclick="viewComic('${encodeURIComponent(comic.name)}')">é è¦½</button>
                <button class="btn-delete" onclick="deleteComic('${comic.name}')">åˆªé™¤</button>
              </div>
            </div>
          `;
          comicGrid.appendChild(card);
        }

        comicListContainer.appendChild(comicGrid);
      } catch (err) {
        console.error('è¼‰å…¥æ¼«ç•«åˆ—è¡¨å¤±æ•—:', err);
        comicListContainer.innerHTML = '<p style="color: #f44336;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚</p>';
      }
    }

    function viewComic(encodedName) {
      window.open(`/viewer.html?name=${encodedName}`, '_blank');
    }

    async function deleteComic(name) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¼«ç•« "${name}"ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`)) {
        return;
      }

      try {
        const res = await fetch(`/deleteComic/${encodeURIComponent(name)}`, { method: 'DELETE' });
        const msg = await res.json();
        
        if (res.ok) {
          showToast(`å·²åˆªé™¤ "${name}"`, 'success');
          await loadComics();
        } else {
          showToast(msg.message || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('åˆªé™¤å‡ºéŒ¯', 'error');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    loadComics();
  </script>
  
  <style>
    @keyframes slideOut {
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</body>
</html>